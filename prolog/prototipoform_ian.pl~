%:- use_module(library(odbc)).

% Predicado para establecer una conexiï¿½n a la base de datos
%:- dynamic restaurante_db/1.
conectar_base_de_datos :-
    odbc_connect('mysqlconexion', Connection,
        [ user('root'),
          password('Coquito21'),
          alias(restaurante_db),
          open(once)
        ]).

desconectar_base_de_datos :- odbc_disconnect(restaurante_db).

%%%%%%%%%%%%%%%%%%%%%Bebidas%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Predicado para obtener bebidas segun el tiempo de comida y temperatura
obtener_bebidas(TiempoComida, Bebidas) :-
    % Comprobar si la temperatura es "fria" o "caliente"
    write('¿Qué temperatura prefieres para las bebidas, fria o caliente (fria/caliente)? '),
    read(Temperatura),

    (Temperatura == 'fria' ->
        % Si es fria, preguntar por el tipo (carbonatadas o naturales)
        elegir_tipo_bebida_fria(TiempoComida, Tipo),
        Bebidas = Tipo
    ;
        % Si es caliente, preguntar si se desea carbonatadas, naturales o todas
        elegir_tipo_bebida_caliente(TiempoComida, Tipo),
        Bebidas = Tipo
    ).

% Predicado para elegir entre bebidas frÃ­as carbonatadas o naturales
elegir_tipo_bebida_fria(TiempoComida, Tipo) :-
    write('¿Deseas bebidas frias carbonatadas o naturales (carbonatadas/naturales)? '),
    read(TipoEleccion),
    (TipoEleccion == 'carbonatadas' ->
        obtener_bebidas_frias(TiempoComida, 'carbonatadas', Tipo)
    ;
        obtener_bebidas_frias(TiempoComida, 'naturales', Tipo)
    ).

% Predicado para obtener bebidas frias carbonatadas o naturales
obtener_bebidas_frias(TiempoComida, Tipo, Bebidas) :-
    % Construir la consulta SQL basada en los para¡metros
    atomic_list_concat(['SELECT nombre FROM bebida WHERE', TiempoComida, '= ''Si'' AND temperatura = ''Fria'' AND', Tipo, '= ''Si'''], ' ', Query),
    % Ejecutar la consulta SQL y obtener los resultados
    findall(Nombre, (odbc_query(restaurante_db, Query, row(Nombre))), Bebidas).

elegir_tipo_bebida_caliente(TiempoComida, Tipo) :-
    write('¿Deseas bebidas calientes carbonatadas o naturales (carbonatadas/naturales)? '),
    read(TipoEleccion),
    (TipoEleccion == 'carbonatadas' ->
        obtener_bebidas_calientes(TiempoComida, 'carbonatadas', Tipo)
    ;
        obtener_bebidas_calientes(TiempoComida, 'naturales', Tipo)
    ).

% Predicado para obtener bebidas calientes carbonatadas o naturales
obtener_bebidas_calientes(TiempoComida, Tipo, Bebidas) :-
    % Construir la consulta SQL basada en los parametros
    atomic_list_concat(['SELECT nombre FROM bebida WHERE', TiempoComida, '= ''Si'' AND temperatura = ''Caliente'' AND', Tipo, '= ''Si'''], ' ', Query),
    % Ejecutar la consulta SQL y obtener los resultados
    findall(Nombre, (odbc_query(restaurante_db, Query, row(Nombre))), Bebidas).

%ejemplo de uso: ?- obtener_bebidas('almuerzo', 'Caliente', Bebidas).


%%%%%%%%%%%%%%%%%%%%%%%%Proteinas%%%%%%%%%%%%%%%%%%%%%

% Predicado para las proteinas

%obtener_proteina(TiempoComida, Registros) :-
    % Construir la consulta SQL basada en los parámetros
%    atomic_list_concat(['SELECT (nombre) FROM proteina WHERE',
%    TiempoComida, '= ''Si'''], ' ', Query),

    % Ejecutar la consulta y obtener la lista de nombres


% Predicado para obtener proteínas según el tipo ingresado por el usuario
obtener_proteina(TiempoComida, Registros) :-
    % Preguntar al usuario por el tipo de proteína
    write('¿Qué tipo de proteína deseas (pollo, mariscos, carnes_rojas)? '),
    read(TipoProteina),

    % Verificar el tipo de proteína y llamar al predicado correspondiente
    (TipoProteina == 'pollo' ->
        obtener_proteina_pollo(TiempoComida, Registros)
    ; TipoProteina == 'mariscos' ->
        obtener_proteina_mariscos(TiempoComida, Registros)
    ; TipoProteina == 'carnes_rojas' ->
        obtener_proteina_carnesRojas(TiempoComida, Registros)
    ; % Manejo de otro caso (por ejemplo, tipo desconocido)
        write('Tipo de proteína desconocido'),
        Registros = [] % Otra acción en caso de tipo desconocido
    ).


% Predicado para las proteinas de pollo
obtener_proteina_pollo(TiempoComida, Registros) :-
        % Construir la consulta SQL basada en los parámetros
    atomic_list_concat(['SELECT (nombre) FROM proteina WHERE', TiempoComida, '= ''Si'' AND tipo = ''Pollo'''], ' ', Query),

    % Ejecutar la consulta y obtener la lista de nombres
    findall(Nombre, (odbc_query(restaurante_db, Query, row(Nombre))), Registros).

% Predicado para las proteinas de mariscos
obtener_proteina_mariscos(TiempoComida, Registros) :-
        % Construir la consulta SQL basada en los parámetros
    atomic_list_concat(['SELECT (nombre) FROM proteina WHERE', TiempoComida, '= ''Si'' AND tipo = ''Mariscos'''], ' ', Query),

    % Ejecutar la consulta y obtener la lista de nombres
    findall(Nombre, (odbc_query(restaurante_db, Query, row(Nombre))), Registros).

obtener_proteina_carnesRojas(TiempoComida, Registros) :-
        % Construir la consulta SQL basada en los parámetros
    atomic_list_concat(['SELECT (nombre) FROM proteina WHERE', TiempoComida, '= ''Si'' AND tipo = ''Carnes Rojas'''], ' ', Query),

    % Ejecutar la consulta y obtener la lista de nombres
    findall(Nombre, (odbc_query(restaurante_db, Query, row(Nombre))), Registros).


%%%%%%%%%%%%%%%%%%%%%Acompannamientos%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Predicado para obtener acompannamientos segun el tiempo de comida y
% un numero aleatorio entre 1 y 3
% obtener_acompannamientos(TiempoComida, NumAcompannamientos, Acompannamientos) :-
    % Obtiene la lista de acompaÃ±amientos para el tiempo de comida dado
%    atomic_list_concat(['SELECT nombre FROM acompannamiento WHERE',
%    TiempoComida, '= ''Si'''], ' ', Query), Ejecuta la consulta SQL y
%    obtiene los nombres de los acompaÃ±amientos
    %findall(Nombre, (odbc_query(restaurante_db, Query, row(Nombre))), TodosAcompannamientos),
    % Obtiene una seleccion aleatoria de acompaÃ±amientos segÃºn NumAcompannamientos
    %length(TodosAcompannamientos, TotalAcompannamientos),
    %random_permutation(TodosAcompannamientos, AcompannamientosAleatorios),
    %take(NumAcompannamientos, AcompannamientosAleatorios, Acompannamientos).

% Predicado para tomar los primeros N elementos de una lista
%take(0, _, []).
%take(N, [X | Xs], [X | Ys]) :-
%    N > 0,
%    N1 is N - 1,
%    take(N1, Xs, Ys).
%take(_, _, []).

%ejemplo de uso: obtener_acompannamientos('desayuno', 2, Acompannamientos).

% Predicado para obtener acompannamientos segun el tiempo de comida y
% temperatura
obtener_acompannamientos(TiempoComida, Acompannamientos) :-
    % Comprobar si la temperatura es "fria" o "caliente"
    write('¿Qué temperatura prefieres para los acompannamientos, frios o calientes (fria/caliente)? '),
    read(Temperatura),

    (Temperatura == 'frios' ->
        % Si es fria, preguntar por el tipo (carbonatadas o naturales)
        obtener_acompannamientos_frios(TiempoComida, Tipo),
        Acompannamientos = Tipo
    ;
        % Si es caliente, preguntar si se desea carbonatadas, naturales o todas
        obtener_acompannamientos_calientes(TiempoComida, Tipo),
        Acompannamientos = Tipo
    ),
     write('¿Cuántos acompañamientos deseas (1/2/3)? '),
    read(Cantidad),
    obtener_acompannamientos_seleccionados(Cantidad, Acompannamientos).

% Predicado para obtener acompañamientos seleccionados
obtener_acompannamientos_seleccionados(1, [Acompannamiento]) :-
    obtener_acompannamiento_aleatorio(Acompannamiento).

obtener_acompannamientos_seleccionados(2, [Acompannamiento1, Acompannamiento2]) :-
    obtener_acompannamiento_aleatorio(Acompannamiento1),
    obtener_acompannamiento_aleatorio(Acompannamiento2),
    Acompannamiento1 \= Acompannamiento2.

obtener_acompannamientos_seleccionados(3, [Acompannamiento1, Acompannamiento2, Acompannamiento3]) :-
    obtener_acompannamiento_aleatorio(Acompannamiento1),
    obtener_acompannamiento_aleatorio(Acompannamiento2),
    obtener_acompannamiento_aleatorio(Acompannamiento3),
    Acompannamiento1 \= Acompannamiento2,
    Acompannamiento1 \= Acompannamiento3,
    Acompannamiento2 \= Acompannamiento3.

% Predicado para obtener un acompañamiento aleatorio
obtener_acompannamiento_aleatorio(Acompannamiento) :-
    odbc_query(restaurante_db,
        'SELECT nombre FROM acompannamiento ORDER BY RAND() LIMIT 1',
        row(Acompannamiento)).



% Predicado para obtener acompañamientos calientes
obtener_acompannamientos_calientes(TiempoComida, Acompannamientos) :-
    write('¿Deseas acompañamientos con vegetales (si/no)? '),
    read(EleccionVegetales),

    write('¿Deseas acompañamientos con carbohidratos (si/no)? '),
    read(EleccionCarbohidratos),

    % Construir la consulta SQL basada en los parámetros
    atomic_list_concat(['SELECT nombre FROM acompannamiento WHERE', TiempoComida, '= ''Si'' AND temperatura = ''Caliente'''], ' ', Query),

    % Agregar las condiciones de EleccionVegetales y EleccionCarbohidratos si son "Si"
    (EleccionVegetales = 'si' ->
        atomic_list_concat([' AND vegetales = ''Si'''], '', VegetalesCondition)
    ;

    EleccionVegetales = 'no' ->
        atomic_list_concat([' AND vegetales = ''No'''], '', VegetalesCondition)
    ;
        VegetalesCondition = ''
    ),

    (EleccionCarbohidratos = 'si' ->
        atomic_list_concat([' AND carbohidratos = ''Si'''], '', CarbohidratosCondition)
    ;
    EleccionVegetales = 'no' ->
       atomic_list_concat([' AND carbohidratos = ''No'''], '', CarbohidratosCondition)
    ;
        CarbohidratosCondition = ''
    ),


    % Ejecutar la consulta SQL y obtener los resultados
    atomic_list_concat([Query, VegetalesCondition, CarbohidratosCondition], ' ', FinalQuery),
    findall(Nombre, (odbc_query(restaurante_db, FinalQuery, row(Nombre))), Acompannamientos).


% Predicado para obtener acompañamientos frios
obtener_acompannamientos_frios(TiempoComida, Acompannamientos) :-
    write('¿Deseas acompañamientos con vegetales (si/no)? '),
    read(EleccionVegetales),

    write('¿Deseas acompañamientos con carbohidratos (si/no)? '),
    read(EleccionCarbohidratos),

    % Construir la consulta SQL basada en los parámetros
    atomic_list_concat(['SELECT nombre FROM acompannamiento WHERE', TiempoComida, '= ''Si'' AND temperatura = ''Frio'''], ' ', Query),

    % Agregar las condiciones de EleccionVegetales y EleccionCarbohidratos si son "Si"
    (EleccionVegetales = 'si' ->
        atomic_list_concat([' AND vegetales = ''Si'''], '', VegetalesCondition)
    ;

    EleccionVegetales = 'no' ->
        atomic_list_concat([' AND vegetales = ''No'''], '', VegetalesCondition)
    ;
        VegetalesCondition = ''
    ),

    (EleccionCarbohidratos = 'si' ->
        atomic_list_concat([' AND carbohidratos = ''Si'''], '', CarbohidratosCondition)
    ;
    EleccionVegetales = 'no' ->
       atomic_list_concat([' AND carbohidratos = ''No'''], '', CarbohidratosCondition)
    ;
        CarbohidratosCondition = ''
    ),


    % Ejecutar la consulta SQL y obtener los resultados
    atomic_list_concat([Query, VegetalesCondition, CarbohidratosCondition], ' ', FinalQuery),
    findall(Nombre, (odbc_query(restaurante_db, FinalQuery, row(Nombre))), Acompannamientos).


%%%%%%%%%%%%%%%%%%%%%%%%Postres%%%%%%%%%%%%%%%%%%

% Predicado para obtener postres segun el tiempo de comida
%obtener_postres(TiempoComida, 'si', Postres) :-
    % Construye la consulta SQL basada en el tiempo de comida
%    atomic_list_concat(['SELECT nombre FROM postre WHERE',
%    TiempoComida, '= ''Si'''], ' ', Query),
    % Ejecuta la consulta SQL y obtiene los nombres de los postres
%    findall(Nombre, (odbc_query(restaurante_db, Query, row(Nombre))),
%    Postres).

% Predicado para obtener postres segun el tiempo de comida sin retornar
% la lista de postres
%obtener_postres(_, 'no', []).

% Predicado para obtener postres segun el tiempo de comida sin
% especificar si se desea o no
%obtener_postres(TiempoComida, Postres) :-
%    obtener_postres(TiempoComida, 'si', Postres).

obtener_postres(TiempoComida, Postres) :-
    % Preguntar si se desea un postre con lácteos (si/no)
    write('¿Deseas un postre con lácteos (si/no)? '),
    read(EleccionLacteos),

    % Llamar a la función correspondiente según la elección
    (EleccionLacteos == 'si' ->
        obtener_postres_con_lacteo(TiempoComida, Postres)
    ;
        obtener_postres_sin_lacteo(TiempoComida, Postres)
    ).


obtener_postres_con_lacteo(TiempoComida,Postres) :-
    write('¿Deseas el postre con frutas (si/no)? '),
    read(EleccionFrutas),

    % Construir la consulta SQL basada en los parámetros
    atomic_list_concat(['SELECT nombre FROM postre WHERE', TiempoComida, '= ''Si'' AND lacteo = ''Si'''], ' ', Query),
    write(EleccionFrutas),
    % Agregar la condición de EleccionFrutas si es "Si" o "No"
    (EleccionFrutas = 'si' ->
        atomic_list_concat([' AND frutas = ''Si'''], '', FrutasCondition)
    ;
        FrutasCondition = ''
    ),

    % Completar la consulta SQL
    atomic_concat(Query, FrutasCondition, FullQuery),

    % Ejecutar la consulta SQL y obtener los resultados
    findall(Nombre, (odbc_query(restaurante_db, FullQuery, row(Nombre))), Postres).

obtener_postres_sin_lacteo(TiempoComida,Postres) :-
    write('¿Deseas el postre con frutas (si/no)? '),
    read(EleccionFrutas),

    % Construir la consulta SQL basada en los parámetros
    atomic_list_concat(['SELECT nombre FROM postre WHERE', TiempoComida, '= ''Si'' AND lacteo = ''No'''], ' ', Query),
    write(EleccionFrutas),
    % Agregar la condición de EleccionFrutas si es "Si" o "No"
    (EleccionFrutas = 'si' ->
        atomic_list_concat([' AND frutas = ''Si'''], '', FrutasCondition)
    ;
        FrutasCondition = ''
    ),

    % Completar la consulta SQL
    atomic_concat(Query, FrutasCondition, FullQuery),

    % Ejecutar la consulta SQL y obtener los resultados
    findall(Nombre, (odbc_query(restaurante_db, FullQuery, row(Nombre))), Postres).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Definición del formulario hacer_menu
obtener_menu :-
    write('Por favor, seleccione el tiempo de comida (desayuno, almuerzo o cena): '),
    read(TiempoComida),
    nl,
    obtener_bebidas(TiempoComida, Bebidas),
    obtener_proteina(TiempoComida, Proteinas),
    %%obtener_acompannamientos(TiempoComida, 2, Acompannamientos),
    obtener_postres(TiempoComida, Postres),
    % Mostrar resultados
    write('*** Menú para '), write(TiempoComida), write(' ***'), nl,
    write('Bebidas: '), write(Bebidas), nl,
    write('Proteínas: '), write(Proteinas), nl,
    %%write('Acompañamientos: '), write(Acompannamientos), nl,
    write('Postres: '), write(Postres), nl.

% Genera todas las combinaciones posibles de los resultados de las funciones
obtener_combinaciones(TiempoComida, Combinaciones) :-
    obtener_bebidas(TiempoComida, Bebidas),
    obtener_proteina(TiempoComida, Proteinas),
    %%obtener_acompannamientos(TiempoComida, 2, Acompannamientos),
    obtener_postres(TiempoComida, Postres),

    % Crear el menú combinando elementos de cada categoría
    findall([Bebida, Proteina, Postre], (
        member(Bebida, Bebidas),
        member(Proteina, Proteinas),
        member(Postre, Postres)
    ), Combinaciones).
